<!DOCTYPE html><html><head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="apple-mobile-web-app-title" content=""><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="description" content="David Jones Blog"><meta name="keywords" content="blog,codding,font-end,web,developer,javascript"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="styles/bootstrap.css"><title>Welcome | David Jones</title></head><body><header class="header-container"><div class="container"><a class="brand" href="/" title="blog.davidkk.com">dBLog</a><nav class="nav"><a href="/tag/index.html" title="tags">Tags</a><a href="/archive/index.html" title="archive">Archives</a></nav></div></header><div class="article-container container context"><main class="content"><article class="article"><h1 class="article-title">OpenWrt - Time Capsule</h1><div class="article-infobar"><div class="category"><i class="fa fa-sticky-note-o"></i><a href="/category/openwrt/1.html" title="openwrt">openwrt</a></div><time class="date"><i class="fa fa-calendar-o"></i><span>2/28/2016, 15:58:37</span></time><div class="author">Written by:&nbsp;<a title="&lt;David Jones qowera@qq.com&gt;" target="_blank">&lt;David Jones qowera@qq.com&gt;</a></div></div><section class="article-content"><p>创建伪 Time Capsule 服务器，能给 Mac OSX Time Machine 做备份使用。## 前期工程先为搭建 Time Capsule 营造基础设施。### 首先创建服务用户及用户组 <code>timemachine:davidjones```</code>
opkg update
opkg install shadow-useradd shadow-groupadd
groupadd timemachine
useradd -M -G timemachine davidjones    # 连接需要用到的用户名建议跟你的 Mac 用户一样
passwd 123                              # 连接需要用到
<code>### 创建备份的文件夹</code>
$ mkdir /mnt/TimeMachine
$ chown -R davidjones:timemachine /mnt/TimeMachine
<code>TimeMachine 文件夹最好为加载的外置存储设备的文件夹，否则可能不够存储空间。详细可以参考 OpenWrt 扩容硬盘及移动设备篇。### 简单扩容演示</code>
$ mount /dev/sdb /mnt/TimeMachine# 设置自动挂载
$ vi /etc/config/fstabconfig mount
  option target   /mnt/TimeMachine
  option device   /dev/sdb            # /dev/sdb 为要挂在的设备
  option fstype   hfsplus
  option options  force,rw,sync
  option enabled  1
  option enabled_fsck 0$ /etc/init.d/fstab start
$ chown -R davidjones:timemachine /mnt/TimeMachine
<code>### 安装 NetatalkNetatalk 是一个免费开源的 AppleTalk 通信协议的实现，Linux 或者 BSD 系统通过它可以充当 Mac 的文件服务器 (AppleShare File Server, 网络协议是 AFP)、AppleTalk 路由、打印服务器等。</code>
$ opkg install netatalk
$ vi /etc/netatalk/afpd.conf&quot;TimeMachine&quot; -uampath /usr/lib/uams -uamlist uams_dhx2.so -nodebug -nouservol -icon -nosavepassword -mimicmodel RackMac$ vi /etc/netatalk/AppleVolumes.default/mnt/TimeMachine TimeMachine volsizelimit:150000 allow:@timemachine rwlist:@timemachine cnidscheme:dbd options:searchdb,usedots,invisibledots,tm$ /etc/init.d/afpd stop
$ /etc/init.d/afpd start
$ /etc/init.d/afpd enable
<code>### 安装 AvahiAvahi 是 Zeroconf 协议实现，包含了一整套多播DNS(multicastDNS)/DNS-SD网络服务的实现。它使用的发布授权是LGPL。Avahi 允许程序在不需要进行手动网络配置的情况 下，在一个本地网络中发布和获知各种服务和主机。</code>
$ opkg install avahi-daemon$ vi /etc/avahi/avahi-daemon.confhost-name=TimeMachine
enable-dbus=no
allow-interfaces=br-lanvi /etc/avahi/services/afpd.service&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE service-group SYSTEM &quot;avahi-service.dtd&quot;&gt;</p>
<p><service-group></p>
<p><name replace-wildcards="yes">Time Capsule</name>
  <service>
    <type>_afpovertcp._tcp</type>
    <port>548</port>
  </service>
  <service>
    <type>_device-info._tcp</type>
    <port>0</port>
    <txt-record>model=TimeCapsule</txt-record>
  </service>
  <service>
    <type>_adisk._tcp</type>
    <port>9</port>
    <txt-record>sys=waMA=XX:XX:XX:XX:XX:XX,adVF=0x100</txt-record>
    <txt-record>dk1=adVF=0x83,adVN=TimeMachine</txt-record>
  </service>
</service-group># XX:XX:XX:XX:XX:XX 为本设备的 mac 地址$ /etc/init.d/avahi-daemon stop
$ /etc/init.d/avahi-daemon start
$ /etc/init.d/avahi-daemon enable
<code>### 通过 OpenWrt 恢复如果你的 Mac Down 了，或者需要通过 TimeMachine 重装，则可以通过修改启动项进入重装界面，与DVD硬盘恢复相同操作，不懂可以上网查找相关资料。
通过打开终端输入以下命令：</code></p>
<h1 id="-mac-">在 Mac 下</h1>
<p>mkdir /Volumes/TimeMachine
mount -t afp &quot;afp://192.168.1.1/TimeMachine&quot; /Volumes/TimeMachine# 192.168.1.1 是 OpenWrt IP
<code>`</code>参考文章- <a href="https://wiki.openwrt.org/doc/howto/timemachine">https://wiki.openwrt.org/doc/howto/timemachine</a></p>
</section><div class="article-widgets"><div class="tags"><i class="fa fa-tags"></i><a href="/tag/openwrt/1.html" title="openwrt">openwrt</a><a href="/tag/路由器/1.html" title="路由器">路由器</a><a href="/tag/Time Capsule/1.html" title="Time Capsule">Time Capsule</a><a href="/tag/Netatalk/1.html" title="Netatalk">Netatalk</a><a href="/tag/Avahi/1.html" title="Avahi">Avahi</a></div></div></article><nav class="pagination"><ul class="pagination-simple"><li><a href="/article/前端开发 - 模块化@Javascript.html" title="前端开发 - 模块化@Javascript"><span>Previous</span><span>前端开发 - 模块化@Javascript</span></a></li><li><a href="/article/OpenWrt - DLNA 服务.html" title="OpenWrt - DLNA 服务"><span>Next</span><span>OpenWrt - DLNA 服务</span></a></li></ul></nav><div class="comments"><div class="disqus-plugin"><div id="disqus_thread"></div><script>!(function() {
  var d = document;
  s = d.createElement('script');
  s.src = '//davidkk.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  !(d.head || d.body).appendChild(s);
})();</script></div></div></main></div><footer class="footer-container"><div class="container"><div class="about"><a class="link" href="https://github.com/DavidKk" title="Github" target="_blank"><i class="fa fa-github-alt"></i></a><a class="link" href="http://codepen.io/DavidJones" title="CodePen" target="_blank"><i class="fa fa-codepen"></i></a><a class="link" href="https://twitter.com/Mr_DavidJones" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a><span><i class="fa fa-heart"></i></span><a class="link" href="https://plus.google.com/u/0/111899862347999076942" title="Google Plus" target="_blank"><i class="fa fa-google-plus"></i></a><a class="link" href="http://weibo.com/307853201" title="微博" target="_blank"><i class="fa fa-weibo"></i></a><a class="link" href="mailto:qowera@qq.com" title="E-Mail"><i class="fa fa-envelope-o"></i></a></div><p class="copyright clearfix">Powered by&nbsp;<a href="/">davidkk.com</a>&nbsp;&copy; 2016
,&nbsp;<a href="/static/sitemap.xml" title="Sitemap">Sitemap</a></p></div></footer><script src="scripts/index.js"></script><script id="dsq-count-scr" src="//davidkk.disqus.com/count.js" async></script></body></html>