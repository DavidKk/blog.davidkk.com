<!DOCTYPE html><html><head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="apple-mobile-web-app-title" content=""><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="description" content="David Jones Blog"><meta name="keywords" content="blog,codding,font-end,web,developer,javascript"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="styles/bootstrap.css"><title>Welcome | David Jones</title></head><body><header class="header-container"><div class="container"><a class="brand" href="/" title="blog.davidkk.com">dBLog</a><nav class="nav"><a href="/tag/index.html" title="tags">Tags</a><a href="/archive/index.html" title="archive">Archives</a></nav></div></header><div class="article-container container context"><main class="content"><article class="article"><h1 class="article-title">OpenWrt - Shadowsocks + ChinaDNS + redsocks</h1><div class="article-infobar"><div class="category"><i class="fa fa-sticky-note-o"></i><a href="/category/OpenWrt/1.html" title="OpenWrt">OpenWrt</a></div><time class="date"><i class="fa fa-calendar-o"></i><span>4/11/2015, 12:57:14</span></time><div class="author">Written by:&nbsp;<a title="&lt;David Jones qowera@qq.com&gt;" target="_blank">&lt;David Jones qowera@qq.com&gt;</a></div></div><section class="article-content"><h3 id="chinadns-dns-china-dns-">ChinaDNS防止 DNS 污染服务器已经好了，下面我们让 China DNS#### 安装<code>`</code></h3>
<p>$ opkg update
$ opkg install ChinaDNS
$ opkg install luci-app-chinadns # WebUI
<code>#### 配置安装了 `luci-app-chinadns` 可以直接进入 WebUI 里面进行配置</code>
$ vi /etc/config/chinadnsconfig chinadns &#39;config&#39;
        option dns &#39;114.114.114.114,127.0.0.1:1153&#39;
        option port &#39;1053&#39;
        option enabled &#39;1&#39;
        option apnt_en &#39;1&#39;# 127.0.0.1:1153 这里是刚才上面 pdnsd 的端口，这样就能通过他解决 DNS 污染问题了# 启动
$ /etc/init.d/chinadns start
$ /etc/init.d/chinadns enable
<code>`</code>#### DHCP 配置现在要使 DNS 解析通过 ChinaDNS，我们需要修改以下 DHCP 服务器，同样若安装 WebUI，可以通过 <code>网络 -&gt; DHCP/DNS</code> 进行配置- <code>基本设置</code>里面将 <code>DNS 转发</code> 改成 <code>127.0.0.1#1053</code> ，这里的 1053 是 ChinaDNS 监听的端口。</p>
<ul>
<li><code>HOSTS和解析文件</code>里面将 <code>忽略解析文件</code> 打上√<code>`</code>
$ vi /etc/config/dhcpconfig dnsmasq<pre><code class="hljs rsl">  <span class="hljs-built_in">option</span> domainneeded <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> boguspriv <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> localise_queries <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> rebind_protection <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> rebind_localhost <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> local <span class="hljs-string">'/lan/'</span>
  <span class="hljs-built_in">option</span> domain <span class="hljs-string">'lan'</span>
  <span class="hljs-built_in">option</span> expandhosts <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> authoritative <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> readethers <span class="hljs-string">'1'</span>
  <span class="hljs-built_in">option</span> leasefile <span class="hljs-string">'/tmp/dhcp.leases'</span>
  <span class="hljs-built_in">option</span> noresolv <span class="hljs-string">'1'</span>                 <span class="hljs-meta"># 忽略解析文件</span>
  list server <span class="hljs-string">'127.0.0.1#1053'</span>        <span class="hljs-meta"># DNS 转发# 重启</span></code></pre>$ /etc/init.d/dnsmasq restart
<code>### Shadowsocks#### Shadowsocks Server in VPS</code><h1 id="-">安装</h1>
$ sudo apt-get install python-pip
$ pip install shadowsocks# 启动
$ sudo ssserver -p 443 -k password -m rc4-md5# 后台运行
$ sudo ssserver -p 443 -k password -m rc4-md5 --user nobody -d start# 停止
$ sudo ssserver -d stop
<code>#### Shadowsocks Client in OpenWrt[依赖包](http://sourceforge.net/projects/OpenWrt-dist/files/shadowsocks-libev/)##### 安装</code>
$ opkg install shadowsocks-libev-spec
$ opkg install luci-app-shadowsocks     # WebUI
<code>##### 配置</code>
$ vi /etc/config/shadowsocksconfig shadowsocks &#39;config&#39;<pre><code class="hljs rsl">  <span class="hljs-built_in">option</span> whitelist_enabled <span class="hljs-string">'0'</span>
  <span class="hljs-built_in">option</span> blacklist_enabled <span class="hljs-string">'0'</span>
  <span class="hljs-built_in">option</span> redir_enabled <span class="hljs-string">'0'</span>
  <span class="hljs-built_in">option</span> remote_server <span class="hljs-string">'x.x.x.x'</span>    <span class="hljs-meta"># 服务器IP</span>
  <span class="hljs-built_in">option</span> remote_port <span class="hljs-string">'443'</span>          <span class="hljs-meta"># 服务器端口</span>
  <span class="hljs-built_in">option</span> password <span class="hljs-string">'xxx'</span>             <span class="hljs-meta"># 密码</span>
  <span class="hljs-built_in">option</span> cipher <span class="hljs-string">'rc4-md5'</span>           <span class="hljs-meta"># 加密方式</span>
  <span class="hljs-built_in">option</span> local_port <span class="hljs-string">'11180'</span>         <span class="hljs-meta"># 本地端口</span>
  <span class="hljs-built_in">option</span> enabled <span class="hljs-string">'1'</span><span class="hljs-meta"># 运行</span></code></pre>$ /etc/init.d/shadowsocks start
$ /etc/init.d/shadowsocks enable
<code>### redsocks2#### 安装</code>
$ opkg update
$ opkg install redsocks2
$ opkg install luci-app-redsocks2   # WebUI
<code>#### 配置可以用过 WebUI 进行配置</code>
$ vi /etc/config/redsocks2config redsocks2_base
option loglevel &#39;info&#39;
option enabled &#39;1&#39;config redsocks2_redirect
option local_ip &#39;0.0.0.0&#39;             # 本地IP，监听所有
option local_port &#39;11111&#39;             # 本地端口
option autoproxy &#39;1&#39;                  # 启用自动代理
option timeout &#39;4&#39;                    # 自动代理超时
option ip &#39;127.0.0.1&#39;                 # 本地IP
option port &#39;11180&#39;                   # 这个端口为刚才 Shadowsocks 监听本地端口
option proxy_type &#39;socks5&#39;            # 选择一下 <code>代理服务器类型</code>: socks5config redsocks2_autoproxy
option no_quick_check_seconds &#39;300&#39;
option quick_connect_timeout &#39;2&#39;config redsocks2_ipcache
option cache_size &#39;4&#39;
option cache_file &#39;/tmp/redsocks2_ipcache.txt&#39;
option stale_time &#39;7200&#39;
option autosave_interval &#39;3600&#39;
option port_check &#39;0&#39;config redsocks2_iptables               # iptables重定向设置
option blacklist_enabled &#39;0&#39;          # 启用排除IP
option whitelist_enabled &#39;1&#39;          # 启用白名单
option ipset_whitelist &#39;/etc/chinadns_chnroute.txt&#39; # 白名单路径，这个为 ChinaDNS
option dest_port &#39;11111&#39;              # 目标端口，指向上面的本地端口$ /etc/init.d/redsocks2 start
$ /etc/init.d/redsocks2 enable
<code>`</code>都好了，现在尝试下载百度输入IP，看下有木有经过代理，若没通过本地，则再请求一下 <code>facebook.com</code>，看看能不能打开，
若能则OK了。这里保证 HOSTS 表不能指定相应能访问的 IP 地址，或直接拿台手机进行访问。</li>
</ul>
</section><div class="article-widgets"><div class="tags"><i class="fa fa-tags"></i><a href="/tag/OpenWrt/1.html" title="OpenWrt">OpenWrt</a><a href="/tag/路由器/1.html" title="路由器">路由器</a><a href="/tag/Shadowsocks/1.html" title="Shadowsocks">Shadowsocks</a><a href="/tag/ChinaDNS/1.html" title="ChinaDNS">ChinaDNS</a><a href="/tag/redsocks/1.html" title="redsocks">redsocks</a></div></div></article><nav class="pagination"><ul class="pagination-simple"><li><a href="/article/OpenWrt - Samba.html" title="OpenWrt - Samba"><span>Previous</span><span>OpenWrt - Samba</span></a></li><li><a href="/article/OpenWrt - 在扩展硬盘或USB设备中安装应用.html" title="OpenWrt - 在扩展硬盘或USB设备中安装应用"><span>Next</span><span>OpenWrt - 在扩展硬盘或USB设备中安装应用</span></a></li></ul></nav><div class="comments"><div class="disqus-plugin"><div id="disqus_thread"></div><script>!(function() {
  var d = document;
  s = d.createElement('script');
  s.src = '//davidkk.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  !(d.head || d.body).appendChild(s);
})();</script></div></div></main></div><footer class="footer-container"><div class="container"><div class="about"><a class="link" href="https://github.com/DavidKk" title="Github" target="_blank"><i class="fa fa-github-alt"></i></a><a class="link" href="http://codepen.io/DavidJones" title="CodePen" target="_blank"><i class="fa fa-codepen"></i></a><a class="link" href="https://twitter.com/Mr_DavidJones" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a><span><i class="fa fa-heart"></i></span><a class="link" href="https://plus.google.com/u/0/111899862347999076942" title="Google Plus" target="_blank"><i class="fa fa-google-plus"></i></a><a class="link" href="http://weibo.com/307853201" title="微博" target="_blank"><i class="fa fa-weibo"></i></a><a class="link" href="mailto:qowera@qq.com" title="E-Mail"><i class="fa fa-envelope-o"></i></a></div><p class="copyright clearfix">Powered by&nbsp;<a href="/">davidkk.com</a>&nbsp;&copy; 2016
,&nbsp;<a href="/static/sitemap.xml" title="Sitemap">Sitemap</a></p></div></footer><script src="scripts/index.js"></script><script id="dsq-count-scr" src="//davidkk.disqus.com/count.js" async></script></body></html>